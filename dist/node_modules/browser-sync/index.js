#! /usr/bin/env node
"use strict";function newEmitter(){var e=new events.EventEmitter;return e.setMaxListeners(20),e}function getSingletonEmitter(){return singletonEmitter?singletonEmitter:singletonEmitter=newEmitter()}function noop(e){return function(){var t=Array.prototype.slice.call(arguments);return singleton?singleton[e].apply(singleton,t):publicUtils.isStreamArg(e,t)?new PassThrough({objectMode:!0}):void 0}}function initSingleton(){var e;if(instances.length&&(e=instances.filter(function(e){return"singleton"===e.name}),e.length))return logger.error("{yellow:You tried to start Browsersync twice!} To create multiple instances, use {cyan:browserSync.create().init()"),e;var t=Array.prototype.slice.call(arguments);return singleton=create("singleton",getSingletonEmitter()),singletonPlugins.length&&singletonPlugins.forEach(function(e){singleton.instance.registerPlugin.apply(singleton.instance,e.args)}),singleton.init.apply(null,t),singleton}function getSingletonValue(e){var t=getSingle("singleton");return t?t[e]:!1}function getSingle(e){if(instances.length){var t=instances.filter(function(t){return t.name===e});if(t.length)return t[0]}return!1}function create(e,t){e=e||(new Date).getTime(),t=t||newEmitter();var n=new BrowserSync(t),i={name:e,instance:n,exit:require("./lib/public/exit")(n),notify:require("./lib/public/notify")(n),pause:require("./lib/public/pause")(n),resume:require("./lib/public/resume")(n),reload:require("./lib/public/reload")(t),stream:require("./lib/public/stream")(t),cleanup:n.cleanup.bind(n),use:n.registerPlugin.bind(n),getOption:n.getOption.bind(n),emitter:n.events,watch:require("./lib/file-watcher").watch};return n.publicInstance=i,i.init=require("./lib/public/init")(n,e,pjson),Object.defineProperty(i,"active",{get:function(){return n.active}}),Object.defineProperty(i,"paused",{get:function(){return n.paused}}),Object.defineProperty(i,"sockets",{get:function(){return n.active?n.io.sockets:{emit:function(){},on:function(){}}}}),instances.push(i),i}var pjson=require("./package.json"),BrowserSync=require("./lib/browser-sync"),publicUtils=require("./lib/public/public-utils"),events=require("events"),PassThrough=require("stream").PassThrough,logger=require("eazy-logger").Logger({useLevelPrefixes:!0}),singleton=!1,singletonPlugins=[],instances=[],singletonEmitter=!1;module.exports=initSingleton,module.exports.create=create,module.exports.get=function(e){var t=getSingle(e);if(t)return t;throw new Error("An instance with the name `%s` was not found.".replace("%s",e))},module.exports.has=function(e){var t=getSingle(e);return!!t},module.exports.init=initSingleton,module.exports.use=function(){var e=Array.prototype.slice.call(arguments);singletonPlugins.push({args:e})},module.exports.reload=noop("reload"),module.exports.stream=noop("stream"),module.exports.notify=noop("notify"),module.exports.exit=noop("exit"),module.exports.watch=noop("watch"),module.exports.pause=noop("pause"),module.exports.resume=noop("resume"),Object.defineProperties(module.exports,{emitter:{get:function(){return singletonEmitter?singletonEmitter:singletonEmitter=newEmitter()}},active:{get:getSingletonValue.bind(null,"active")},paused:{get:getSingletonValue.bind(null,"paused")}}),module.exports.reset=function(){instances.forEach(function(e){e.cleanup()}),instances=[],singletonPlugins=[],singletonEmitter=!1,singleton=!1},module.exports.instances=instances;