function openDatabase(){return navigator.serviceWorker?idb.open("transport",1,function(e){var t=e.createObjectStore("transports",{keyPath:"id"});t.createIndex("by-trip","trip_id")}):Promise.resolve()}function validateFrom(){var e="";document.getElementById("fromStop").validity.valueMissing&&(e="Please select out the field."),document.getElementById("from-err").innerHTML=e}function validateTo(){var e="";document.getElementById("toStop").validity.valueMissing&&(e="Please select out the field."),document.getElementById("to-err").innerHTML=e}function validateDay(){var e="";document.getElementById("serviceDay").validity.valueMissing&&(e="Please select out the field."),document.getElementById("day-err").innerHTML=e}function assignService(e){var t="";return e.startsWith("TaSj")&&(t="Caltrain Shuttle"),e.startsWith("Lo")&&(t="Local"),e.startsWith("Li")&&(t="Limited"),e.startsWith("Bu")&&(t="Baby Bullet"),t}navigator.serviceWorker&&navigator.serviceWorker.register("./sw.js").then(function(e){navigator.serviceWorker.controller&&console.log("Service Worker Registered.")},function(e){console.log(e)});var dbPromise=openDatabase(),fromValue="",toValue="",serviceDay="",stopArr=[],tripArr=[],stopTimesArr=[],stationNames=[];$.getJSON("data/trips.json").done(function(e){tripArr=e,$.getJSON("data/stop_times.json").done(function(e){$.each(e,function(e,t){$.each(tripArr,function(e,n){if(t.trip_id===n.trip_id){var s={trip_id:t.trip_id,arrival_time:t.arrival_time,departure_time:t.departure_time,stop_id:t.stop_id,stop_sequence:t.stop_sequence,pickup_type:t.pickup_type,drop_off_type:t.drop_off_type,route_id:n.route_id,service_id:n.service_id};stopTimesArr.push(s)}})}),$.getJSON("data/stops.json").done(function(e){$.each(e,function(e,t){$.each(stopTimesArr,function(e,n){if(n.stop_id===t.stop_id){var s=n.trip_id+n.stop_sequence,a={id:s,stop_id:n.stop_id,stop_name:t.stop_name,arrival_time:n.arrival_time,departure_time:n.departure_time,trip_id:n.trip_id,stop_sequence:n.stop_sequence,route_id:n.route_id,service_id:n.service_id};stopArr.push(a)}})}),$.each(stopArr,function(e,t){-1===stationNames.indexOf(t.stop_name)&&stationNames.push(t.stop_name)}),$.each(stationNames,function(e,t){$("#fromStop").append("<option>"+t+"</option>"),$("#toStop").append("<option>"+t+"</option>")}),dbPromise.then(function(e){if(e){var t=e.transaction("transports","readwrite"),n=t.objectStore("transports");stopArr.forEach(function(e){n.put(e)})}})}).fail(function(e,t,n){var s=t+","+n;console.log("Stops Request Failed: "+s)})}).fail(function(e,t,n){var s=t+","+n;console.log("Stop_Times Request Failed: "+s)})}).fail(function(e,t,n){var s=t+","+n;console.log("Trips Request Failed: "+s)}),$("#search").on("click",function(e){return $(".modal-content").html(""),fromValue=$("#fromStop").val(),toValue=$("#toStop").val(),serviceDay=$("#serviceDay").val(),""===fromValue||""===toValue||""===serviceDay?void $("#form-err").text("Please provide all values"):fromValue===toValue?void $("#form-err").text("Both stations should be different"):($(".modal-content").append('<h3>Select Any Trip</h3><table><tr><th>Trip ID</th><th>Arrival Time</th>+<th>Departure Time</th><th>Stop Seq</th></tr></table><button id="returnMain" class="btn btn-primary">Return</button>'),void dbPromise.then(function(e){if(e){var t=e.transaction("transports").objectStore("transports").index("by-trip");return t.getAll().then(function(e){e.forEach(function(e,t,n){fromValue===e.stop_name&&e.service_id.indexOf(serviceDay)>0&&$(".modal-content table").append("<tr><td>"+e.trip_id+"</td><td>"+e.arrival_time+"</td><td>"+e.departure_time+"</td><td>"+e.stop_sequence+"</td></tr>")})})}}))}),$(".modal-content").on("click","tr",function(){$(".trip-modal").modal("hide");var e=($("tr").index(this),$(this).find("td").eq(0).text());dbPromise.then(function(t){if(t){var n=t.transaction("transports").objectStore("transports").index("by-trip");return n.getAll(e).then(function(e){fromValue=$("#fromStop").val(),toValue=$("#toStop").val();var t=$.grep(e,function(e){return e.stop_name===fromValue}),n=$.grep(e,function(e){return e.stop_name===toValue});if(0===t.length||0===n.length)return void $("#schedules").html("Sorry!!! This trip is not available. Please choose another trip.");if($("#schedules").html('<h3>Schedule - from: <span class="style-item">'+fromValue.replace("Caltrain","")+'</span> to: <span class="style-item">'+toValue.replace("Caltrain","")+"</span></h3>"),parseInt(t[0].stop_sequence)<parseInt(n[0].stop_sequence)){$("#schedules").append("<span>"+fromValue+" ("+assignService(t[0].route_id)+")</span><br>"),$("#schedules").append("<span>"+t[0].arrival_time+'</span><span class="glyphicon glyphicon-triangle-bottom"></span><br>'),$("#schedules").append('<span class="glyphicon glyphicon-option-vertical"></span><br>'),$("#schedules").append("<span>"+t[0].departure_time+'</span><span class="glyphicon glyphicon-triangle-bottom"></span><br><br>'),$("#schedules").append('<div id="route-icon"></div><br>');for(var s=t[0].route_id,a=parseInt(t[0].stop_sequence)+1;a<=parseInt(n[0].stop_sequence)-1;a++){var r=$.grep(e,function(e){return parseInt(e.stop_sequence)===a});r&&r[0].route_id!==s&&(s=r[0].route_id,$("#schedules").append("<span>"+r[0].stop_name+" ("+assignService(r[0].route_id)+")</span><br>"),$("#schedules").append("<span>"+r[0].arrival_time+'</span><span class="glyphicon glyphicon-triangle-bottom"></span><br>'),$("#schedules").append('<span class="glyphicon glyphicon-option-vertical"></span><br>'),$("#schedules").append("<span>"+r[0].departure_time+'</span><span class="glyphicon glyphicon-triangle-bottom"></span><br><br>'),$("#schedules").append('<div id="route-icon"></div><br>'))}$("#schedules").append("<span>"+toValue+"</span><br>"),$("#schedules").append("<span>"+n[0].arrival_time+'</span><br><span class="glyphicon glyphicon-record"></span><br>')}else{$("#schedules").append("<span>"+fromValue+" ("+assignService(t[0].route_id)+")</span><br>"),$("#schedules").append("<span>"+t[0].arrival_time+'</span><br><span class="glyphicon glyphicon-record"></span><br><br>'),$("#schedules").append('<div id="route-icon"></div><br>');for(var s=t[0].route_id,a=parseInt(t[0].stop_sequence)-1;a>=parseInt(n[0].stop_sequence)+1;a--){var r=$.grep(e,function(e){return parseInt(e.stop_sequence)===a});r&&r[0].route_id!==s&&(s=r[0].route_id,$("#schedules").append("<span>"+r[0].stop_name+" ("+assignService(r[0].route_id)+")</span><br>"),$("#schedules").append("<span>"+r[0].arrival_time+'</span><span class="glyphicon glyphicon-triangle-top"></span><br>'),$("#schedules").append('<span class="glyphicon glyphicon-option-vertical"></span><br>'),$("#schedules").append("<span>"+r[0].departure_time+'</span><span class="glyphicon glyphicon-triangle-top"></span><br><br>'),$("#schedules").append('<div id="route-icon"></div><br>'))}$("#schedules").append("<span>"+toValue+"</span><br>"),$("#schedules").append("<span>"+n[0].arrival_time+'</span><span class="glyphicon glyphicon-triangle-top"></span><br>'),$("#schedules").append('<span class="glyphicon glyphicon-option-vertical"></span><br>'),$("#schedules").append("<span>"+n[0].departure_time+'</span><span class="glyphicon glyphicon-triangle-top"></span>')}})}}),$("#schedule").removeClass("hide"),$("#schedule").addClass("show"),$(".trips").addClass("hide"),$(".trips").removeClass("show")}),$("#change-trip").on("click",function(){$(".trips").removeClass("hide"),$(".trips").addClass("show"),$("#schedule").removeClass("show"),$("#schedule").addClass("hide")}),$(".modal-content").on("click","#returnMain",function(){$(".trip-modal").modal("hide")});