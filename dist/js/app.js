function openDatabase(){return navigator.serviceWorker?idb.open("transport",1,function(e){var t=e.createObjectStore("transports",{keyPath:"id"});t.createIndex("by-trip","trip_id")}):Promise.resolve()}function validateFrom(){var e="";document.getElementById("fromStop").validity.valueMissing&&(e="Please select out the field."),document.getElementById("from-err").innerHTML=e}function validateTo(){var e="";document.getElementById("toStop").validity.valueMissing&&(e="Please select out the field."),document.getElementById("to-err").innerHTML=e}function validateDay(){var e="";document.getElementById("serviceDay").validity.valueMissing&&(e="Please select out the field."),document.getElementById("day-err").innerHTML=e}function assignService(e){var t="";return e.startsWith("TaSj")&&(t="Caltrain Shuttle"),e.startsWith("Lo")&&(t="Local"),e.startsWith("Li")&&(t="Limited"),e.startsWith("Bu")&&(t="Baby Bullet"),t}navigator.serviceWorker&&navigator.serviceWorker.register("sw.js").then(function(e){navigator.serviceWorker.controller&&console.log("Service Worker Registered.")},function(e){console.log(e)});var dbPromise=openDatabase(),fromValue="",toValue="",serviceDay="",stopArr=[],tripArr=[],stopTimesArr=[],stationNames=[];$.getJSON("data/trips.json").done(function(e){tripArr=e,$.getJSON("data/stop_times.json").done(function(e){$.each(e,function(e,t){$.each(tripArr,function(e,n){if(t.trip_id===n.trip_id){var r={trip_id:t.trip_id,arrival_time:t.arrival_time,departure_time:t.departure_time,stop_id:t.stop_id,stop_sequence:t.stop_sequence,pickup_type:t.pickup_type,drop_off_type:t.drop_off_type,route_id:n.route_id,service_id:n.service_id,direction_id:n.direction_id};stopTimesArr.push(r)}})}),$.getJSON("data/stops.json").done(function(e){$.each(stopTimesArr,function(t,n){$.each(e,function(e,t){if(n.stop_id===t.stop_id){var r=n.trip_id+n.stop_sequence,i={id:r,stop_id:n.stop_id,stop_name:t.stop_name,arrival_time:n.arrival_time,departure_time:n.departure_time,trip_id:n.trip_id,stop_sequence:n.stop_sequence,route_id:n.route_id,service_id:n.service_id,direction_id:n.direction_id};stopArr.push(i)}})}),$.each(stopArr,function(e,t){-1===stationNames.indexOf(t.stop_name)&&stationNames.push(t.stop_name)}),$.each(stationNames,function(e,t){$("#fromStop").append("<option>"+t+"</option>"),$("#toStop").append("<option>"+t+"</option>")}),dbPromise.then(function(e){if(e){var t=e.transaction("transports","readwrite"),n=t.objectStore("transports");stopArr.forEach(function(e){n.put(e)})}})}).fail(function(e,t,n){var r=t+","+n;console.log("Stops Request Failed: "+r)})}).fail(function(e,t,n){var r=t+","+n;console.log("Stop_Times Request Failed: "+r)})}).fail(function(e,t,n){var r=t+","+n;console.log("Trips Request Failed: "+r)}),$("#search").on("click",function(e){return $(".modal-content").html(""),$("#form-err").text(""),fromValue=$("#fromStop").val(),toValue=$("#toStop").val(),serviceDay=$("#serviceDay").val(),""===fromValue||""===toValue||""===serviceDay?void $("#form-err").text("Please provide all values"):fromValue===toValue?void $("#form-err").text("Both stations should be different"):($(".modal-content").append('<h3>Select Any Trip</h3><table><tr><th>Trip ID</th><th>Arrival Time</th>+<th>Departure Time</th><th>Stop Seq</th></tr></table><button id="returnMain" class="btn btn-primary">Return</button>'),void dbPromise.then(function(e){if(e){var t=e.transaction("transports").objectStore("transports").index("by-trip");return t.getAll().then(function(e){var t=[];e.forEach(function(e,n,r){fromValue===e.stop_name&&e.service_id.indexOf(serviceDay)>0&&t.push({trip_id:e.trip_id,arr_time:e.arrival_time,dep_time:e.departure_time,stop_seq:e.stop_sequence})}),0===t.length?$(".modal-content").append("<h4>Sorry!!! There are no service available between selected stations on this service Day. Please select other stations or service Day.</h4>"):t.forEach(function(e,t,n){$(".modal-content table").append("<tr><td>"+e.trip_id+"</td><td>"+e.arr_time+"</td><td>"+e.dep_time+"</td><td>"+e.stop_seq+"</td></tr>")})})}}))}),$(".modal-content").on("click","tr",function(){$(".trip-modal").modal("hide");var e=($("tr").index(this),$(this).find("td").eq(0).text());dbPromise.then(function(t){if(t){var n=t.transaction("transports").objectStore("transports").index("by-trip");return n.getAll(e).then(function(e){fromValue=$("#fromStop").val(),toValue=$("#toStop").val();var t=$.grep(e,function(e){return e.stop_name===fromValue}),n=$.grep(e,function(e){return e.stop_name===toValue});if(0===t.length||0===n.length)return void $("#schedules").html("Sorry!!! This trip is not available. Please choose another trip.");if($("#schedules").html('<h3>Schedule - from: <span class="style-item">'+fromValue.replace("Caltrain","")+'</span> to: <span class="style-item">'+toValue.replace("Caltrain","")+"</span></h3>"),parseInt(t[0].stop_sequence)<parseInt(n[0].stop_sequence)){$("#schedules").append("<span>"+fromValue+" ("+assignService(t[0].route_id)+")</span><br>"),$("#schedules").append("<span>"+t[0].arrival_time+'</span><img src="imgs/glyphicons/png/glyphicons-349-hand-down.png"><br>'),$("#schedules").append('<img src="imgs/glyphicons/png/glyphicons-518-option-vertical.png"><br>'),$("#schedules").append("<span>"+t[0].departure_time+'</span><img src="imgs/glyphicons/png/glyphicons-349-hand-down.png"><br><br>'),$("#schedules").append('<div id="route-icon"></div><br>');for(var r=t[0].route_id,i=parseInt(t[0].stop_sequence)+1;i<=parseInt(n[0].stop_sequence)-1;i++){var s=$.grep(e,function(e){return parseInt(e.stop_sequence)===i});s&&s[0].route_id!==r&&(r=s[0].route_id,$("#schedules").append("<span>"+s[0].stop_name+" ("+assignService(s[0].route_id)+")</span><br>"),$("#schedules").append("<span>"+s[0].arrival_time+'</span><img src="imgs/glyphicons/png/glyphicons-349-hand-down.png"><br>'),$("#schedules").append('<img src="imgs/glyphicons/png/glyphicons-518-option-vertical.png"><br>'),$("#schedules").append("<span>"+s[0].departure_time+'</span><img src="imgs/glyphicons/png/glyphicons-349-hand-down.png"></span><br><br>'),$("#schedules").append('<div id="route-icon"></div><br>'))}$("#schedules").append("<span>"+toValue+"</span><br>"),$("#schedules").append("<span>"+n[0].arrival_time+'</span><br><img src="imgs/glyphicons/png/glyphicons-170-record.png"><br>')}else{$("#schedules").append("<span>"+fromValue+" ("+assignService(t[0].route_id)+")</span><br>"),$("#schedules").append("<span>"+t[0].arrival_time+'</span><br><img src="imgs/glyphicons/png/glyphicons-170-record.png"><br><br>'),$("#schedules").append('<div id="route-icon"></div><br>');for(var r=t[0].route_id,i=parseInt(t[0].stop_sequence)-1;i>=parseInt(n[0].stop_sequence)+1;i--){var s=$.grep(e,function(e){return parseInt(e.stop_sequence)===i});s&&s[0].route_id!==r&&(r=s[0].route_id,$("#schedules").append("<span>"+s[0].stop_name+" ("+assignService(s[0].route_id)+")</span><br>"),$("#schedules").append("<span>"+s[0].arrival_time+'</span><img src="imgs/glyphicons/png/glyphicons-348-hand-up.png"><br>'),$("#schedules").append('<img src="imgs/glyphicons/png/glyphicons-518-option-vertical.png"><br>'),$("#schedules").append("<span>"+s[0].departure_time+'</span><img src="imgs/glyphicons/png/glyphicons-348-hand-up.png"><br><br>'),$("#schedules").append('<div id="route-icon"></div><br>'))}$("#schedules").append("<span>"+toValue+"</span><br>"),$("#schedules").append("<span>"+n[0].arrival_time+'</span><img src="imgs/glyphicons/png/glyphicons-348-hand-up.png"><br>'),$("#schedules").append('<img src="imgs/glyphicons/png/glyphicons-518-option-vertical.png"><br>'),$("#schedules").append("<span>"+n[0].departure_time+'</span><img src="imgs/glyphicons/png/glyphicons-348-hand-up.png">')}})}}),$("#schedule").removeClass("hide"),$("#schedule").addClass("show"),$(".trips").addClass("hide"),$(".trips").removeClass("show")}),$("#change-trip").on("click",function(){$(".trips").removeClass("hide"),$(".trips").addClass("show"),$("#schedule").removeClass("show"),$("#schedule").addClass("hide")}),$(".modal-content").on("click","#returnMain",function(){$(".trip-modal").modal("hide")});